import asyncio

from fastapi import APIRouter, HTTPException, WebSocket, WebSocketDisconnect

from schemas.exploiter_schema import ExploiterRequestBody
from services.exploiter_service import ExploiterService
from services.llm_service import LLMService
from services.websocket_service import manager

router = APIRouter(prefix="/exploiter", tags=["exploiter"])

llm_service = LLMService()
exploiter_service = ExploiterService()

@router.websocket("/ws/{ws_id}")
async def websocket_exploiter_status(websocket: WebSocket, ws_id: str):
    await manager.connect(websocket, ws_id)
    try:
        while True:
            await websocket.receive_text()
    except WebSocketDisconnect:
        manager.disconnect(websocket, ws_id)


@router.post("/run")
async def exploiter_run(body: ExploiterRequestBody):
    try:
        if body.ws_id:
            await manager.broadcast(body.ws_id, {"type": "info", "message": f"[*] Инициализация атаки на {body.target}..."})
            await manager.broadcast(body.ws_id, {"type": "info", "message": f"[*] Генерация LLM payload'ов для {body.vuln_type}..."})

        payloads_task = asyncio.create_task(
            llm_service.ask_for_payloads(body.target, body.vuln_type, body.params)
        )

        msg = f"[+] Используем предоставленные cookies для авторизации..."
        print(msg)
        if body.ws_id: await manager.broadcast(body.ws_id, {"type": "info", "message": msg})

        cookies = body.cookies

        payloads = await payloads_task
        if not payloads:
            payloads = ["<script>alert(1)</script>", "\"'><img src=x onerror=alert(1)>"]

        msg = f"[+] Получено {len(payloads)} ответных payload'ов от ИИ"
        print(msg)
        if body.ws_id: await manager.broadcast(body.ws_id, {"type": "info", "message": msg})

        tried_payloads = []

        for payload in payloads:
            tried_payloads.append(payload)
            if body.ws_id: await manager.broadcast(body.ws_id, {"type": "attack", "payload": payload, "status": "testing"})

            success, message, curl_command = await exploiter_service.try_exploit(
                vuln_type=body.vuln_type,
                url=body.target,
                method=body.method,
                param=body.params,
                data={"payloads": payload},
                cookies=cookies,
                ws_id=body.ws_id
            )
            print(message)
            if success:
                if body.ws_id: await manager.broadcast(body.ws_id, {"type": "success", "message": message, "payload": payload})
                return {
                    "status": "confirmed",
                    "vuln_type": body.vuln_type,
                    "target": body.target,
                    "parameter": body.params,
                    "working_payload": payload,
                    "tried_payloads": tried_payloads,
                    "proof": message,
                    "curl": curl_command,
                    "message": "Уязвимость успешно подтверждена и эксплуатирована!"
                }
            else:
                 if body.ws_id: await manager.broadcast(body.ws_id, {"type": "failed", "message": message, "payload": payload})

        return {
            "status": "potential",
            "message": "Ни один payload не сработал. Возможно, нужна ручная проверка.",
            "tried_payloads": payloads[:10]
        }

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Ошибка при эксплуатации: {str(e)}")
