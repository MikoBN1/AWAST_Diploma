<script setup lang="ts">
import { ref, watch, onBeforeUnmount } from 'vue';
import exploiterService from '@/services/exploiterService';
import type { ExploiterResponse } from '@/types/api';

const props = defineProps<{
  modelValue: boolean;
  initialUrl: string;
  initialMethod: string;
  initialVulnType: string;
}>();

const emit = defineEmits(['update:modelValue']);

// Form State
const targetUrl = ref(props.initialUrl);
const method = ref(props.initialMethod);
const vulnType = ref(props.initialVulnType);
const params = ref('');

// Cookies key-value editor
interface CookieEntry {
  key: string;
  value: string;
}
const cookieEntries = ref<CookieEntry[]>([]);
const showCookies = ref(false);

const addCookieEntry = () => {
  cookieEntries.value.push({ key: '', value: '' });
};

const removeCookieEntry = (index: number) => {
  cookieEntries.value.splice(index, 1);
};

const buildCookiesObject = (): Record<string, string> | undefined => {
  const entries = cookieEntries.value.filter(e => e.key.trim() !== '');
  if (entries.length === 0) return undefined;
  return Object.fromEntries(entries.map(e => [e.key.trim(), e.value]));
};

// Execution State
const isLoading = ref(false);
const exploitResult = ref<ExploiterResponse | null>(null);
const errorMsg = ref('');

// WebSocket Logs
interface WsLog {
  type: string;
  message?: string;
  payload?: string;
  timestamp: Date;
}
const wsLogs = ref<WsLog[]>([]);
let activeSocket: WebSocket | null = null;
const terminalContainer = ref<HTMLElement | null>(null);

const scrollToBottom = () => {
  setTimeout(() => {
    if (terminalContainer.value) {
      terminalContainer.value.scrollTop = terminalContainer.value.scrollHeight;
    }
  }, 50);
};

// Watch for prop changes to reset/update form when opening
watch(() => props.modelValue, (newVal) => {
    if (newVal) {
        targetUrl.value = props.initialUrl;
        method.value = props.initialMethod;
        vulnType.value = props.initialVulnType;
        exploitResult.value = null;
        wsLogs.value = [];
        errorMsg.value = '';
    }
});

const closeDialog = () => {
    if (activeSocket && activeSocket.readyState === WebSocket.OPEN) {
        activeSocket.close();
    }
    emit('update:modelValue', false);
};

onBeforeUnmount(() => {
    if (activeSocket && activeSocket.readyState === WebSocket.OPEN) {
        activeSocket.close();
    }
});

const runExploit = async () => {
  if (!targetUrl.value) {
    errorMsg.value = 'Please enter a target URL';
    return;
  }
  errorMsg.value = '';
  isLoading.value = true;
  exploitResult.value = null;
  wsLogs.value = [];

  // 1. Generate WS ID
  const wsId = crypto.randomUUID();

  // 2. Connect WebSocket
  if (activeSocket) {
    activeSocket.close();
  }

  const baseUrl = import.meta.env.VITE_API_URL || 'http://localhost:8000/api/v1';
  const wsUrl = baseUrl.replace(/^http/, 'ws') + `/exploiter/ws/${wsId}`;
  activeSocket = new WebSocket(wsUrl);

  activeSocket.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      wsLogs.value.push({ ...data, timestamp: new Date() });
      scrollToBottom();
    } catch (e) {
      console.error("Failed to parse WS message", e);
    }
  };

  activeSocket.onerror = (error) => {
    console.error("WebSocket Error:", error);
    wsLogs.value.push({ type: 'failed', message: 'WebSocket connection error', timestamp: new Date() });
  };

  try {
    const data = {
      target: targetUrl.value,
      params: params.value,
      vuln_type: vulnType.value,
      cookies: buildCookiesObject(),
      method: method.value,
      ws_id: wsId,
    };
    const response = await exploiterService.runExploit(data);
    exploitResult.value = response as ExploiterResponse;
  } catch (error: any) {
    errorMsg.value = error?.response?.data?.detail || 'Exploit execution failed';
  } finally {
    isLoading.value = false;
    if (activeSocket && activeSocket.readyState === WebSocket.OPEN) {
      setTimeout(() => {
        if (activeSocket) activeSocket.close();
      }, 2000);
    }
  }
};
</script>

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="emit('update:modelValue', $event)"
    max-width="900px"
    scrollable
  >
    <v-card class="exploit-dialog-card rounded-xl">
      <v-card-title class="dialog-header py-4 px-6 d-flex align-center justify-space-between">
        <div class="d-flex align-center">
             <v-icon icon="mdi-flash" color="red-accent-2" class="mr-3" size="28"></v-icon>
            <span class="text-h6 font-weight-bold text-white">Run Exploit</span>
        </div>
        <v-btn icon="mdi-close" variant="text" color="white" @click="closeDialog"></v-btn>
      </v-card-title>

      <v-card-text class="pa-6 bg-grey-lighten-5">
        <v-container class="pa-0">
          <!-- Error Alert -->
          <v-alert v-if="errorMsg" type="error" variant="tonal" density="compact" class="mb-4" closable @click:close="errorMsg = ''">{{ errorMsg }}</v-alert>

          <!-- Target Info -->
          <v-row>
            <v-col cols="12" md="8">
              <label class="input-label mb-2">Target URL</label>
              <v-text-field
                v-model="targetUrl"
                density="compact"
                variant="outlined"
                bg-color="white"
                hide-details="auto"
                class="mb-4 modern-input"
                prepend-inner-icon="mdi-link"
              ></v-text-field>
            </v-col>
            <v-col cols="12" md="4">
              <label class="input-label mb-2">Method</label>
              <v-select
                v-model="method"
                :items="['GET', 'POST', 'PUT', 'DELETE']"
                density="compact"
                variant="outlined"
                bg-color="white"
                hide-details="auto"
                class="mb-4 modern-input"
                prepend-inner-icon="mdi-api"
              ></v-select>
            </v-col>
          </v-row>
          
          <v-row>
            <v-col cols="12" md="6">
              <label class="input-label mb-2">Vulnerability Type</label>
              <v-text-field
                v-model="vulnType"
                density="compact"
                variant="outlined"
                bg-color="white"
                hide-details="auto"
                class="mb-4 modern-input"
                prepend-inner-icon="mdi-bug"
              ></v-text-field>
            </v-col>
            <v-col cols="12" md="6">
              <label class="input-label mb-2">Vulnerable Parameter</label>
              <v-text-field
                v-model="params"
                density="compact"
                variant="outlined"
                bg-color="white"
                hide-details="auto"
                placeholder="e.g., id"
                class="mb-4 modern-input"
                prepend-inner-icon="mdi-code-braces"
              ></v-text-field>
            </v-col>
          </v-row>
          
          <!-- Cookies Toggle -->
          <div class="d-flex align-center mb-4">
            <v-switch
              v-model="showCookies"
              label="Session Cookies"
              color="primary"
              hide-details
              density="compact"
              inset
            ></v-switch>
          </div>
          
          <!-- Cookies Editor -->
          <v-expand-transition>
            <div v-if="showCookies" class="credentials-box pa-4 mb-4 rounded-lg">
              <div v-for="(entry, index) in cookieEntries" :key="index" class="d-flex align-center mb-2">
                <v-text-field
                  v-model="entry.key"
                  label="Cookie Name"
                  density="compact"
                  variant="outlined"
                  bg-color="white"
                  hide-details="auto"
                  placeholder="e.g. PHPSESSID"
                  class="mr-2"
                ></v-text-field>
                <v-text-field
                  v-model="entry.value"
                  label="Cookie Value"
                  density="compact"
                  variant="outlined"
                  bg-color="white"
                  hide-details="auto"
                  class="mr-2"
                ></v-text-field>
                <v-btn icon="mdi-close" size="x-small" variant="text" color="red" @click="removeCookieEntry(index)"></v-btn>
              </div>
              <v-btn variant="tonal" color="primary" size="small" prepend-icon="mdi-plus" class="text-none" @click="addCookieEntry">
                Add Cookie
              </v-btn>
            </div>
          </v-expand-transition>

          <!-- WebSocket Terminal Logs -->
          <v-expand-transition>
            <div v-if="isLoading || wsLogs.length > 0" class="terminal-area mb-4">
              <div class="d-flex align-center justify-space-between mb-2">
                <h4 class="text-subtitle-2 font-weight-bold text-grey-darken-3">Exploitation Logs</h4>
                <v-chip v-if="isLoading" color="primary" size="x-small" variant="flat">
                  <v-progress-circular indeterminate size="10" width="2" class="mr-1"></v-progress-circular>
                  Running
                </v-chip>
              </div>
              <v-card variant="flat" color="#1e1e1e" class="pa-3 rounded-lg terminal-window">
                <div class="terminal-body" ref="terminalContainer">
                  <div v-if="wsLogs.length === 0" class="text-grey-darken-1 text-caption font-italic">
                    Connecting to LLM...
                  </div>
                  <div v-for="(log, idx) in wsLogs" :key="idx" class="log-entry mb-1 text-caption">
                    <span class="text-grey-darken-1 mr-1">[{{ log.timestamp.toLocaleTimeString() }}]</span>
                    <span v-if="log.type === 'info'" class="text-blue-lighten-2">[SYSTEM] {{ log.message }}</span>
                    <span v-else-if="log.type === 'log'" class="text-white">&gt; {{ log.message }}</span>
                    <span v-else-if="log.type === 'attack'" class="text-yellow-accent-2">[ATTACK] {{ log.payload }}</span>
                    <span v-else-if="log.type === 'success'" class="text-green-accent-3 font-weight-bold">[VULNERABLE] {{ log.message }}</span>
                    <span v-else-if="log.type === 'failed'" class="text-red-accent-2">[FAILED] {{ log.message }}</span>
                    <span v-else class="text-white">{{ log.message }}</span>
                  </div>
                  <div v-if="isLoading" class="log-entry mt-1"><span class="blinking-cursor">_</span></div>
                </div>
              </v-card>
            </div>
          </v-expand-transition>
          
          <!-- Results -->
          <v-expand-transition>
            <div v-if="exploitResult && !isLoading" class="results-container mt-4">
              <h4 class="text-subtitle-2 font-weight-bold mb-2 text-grey-darken-3">Execution Result</h4>

              <!-- Confirmed -->
              <template v-if="exploitResult.status === 'confirmed'">
                <v-alert type="success" variant="tonal" density="compact" class="mb-3">
                  {{ exploitResult.message }}
                </v-alert>
                <v-card variant="flat" color="#1e1e1e" class="pa-4 rounded-lg">
                  <div class="text-caption text-grey-lighten-1 mb-1">Working Payload:</div>
                  <code class="text-green-accent-3 d-block mb-3">{{ exploitResult.working_payload }}</code>
                  <div class="text-caption text-grey-lighten-1 mb-1">Proof:</div>
                  <div class="text-body-2 text-white mb-3">{{ exploitResult.proof }}</div>
                  <div class="text-caption text-grey-lighten-1 mb-1">cURL:</div>
                  <code class="text-yellow-accent-2 d-block" style="word-break: break-all;">{{ exploitResult.curl }}</code>
                </v-card>
              </template>

              <!-- Potential -->
              <template v-else-if="exploitResult.status === 'potential'">
                <v-alert type="warning" variant="tonal" density="compact" class="mb-3">
                  {{ exploitResult.message }}
                </v-alert>
                <v-card variant="flat" color="#1e1e1e" class="pa-4 rounded-lg">
                  <div class="text-caption text-grey-lighten-1 mb-2">Tried Payloads ({{ exploitResult.tried_payloads.length }}):</div>
                  <v-chip
                    v-for="(p, i) in exploitResult.tried_payloads"
                    :key="i"
                    size="small"
                    variant="outlined"
                    color="grey-lighten-1"
                    class="mr-1 mb-1"
                  >{{ p }}</v-chip>
                </v-card>
              </template>
            </div>
          </v-expand-transition>

        </v-container>
      </v-card-text>

      <v-divider></v-divider>

      <v-card-actions class="pa-4 bg-white">
        <v-spacer></v-spacer>
        <v-btn
          variant="text"
          color="grey-darken-1"
          @click="closeDialog"
          class="text-none font-weight-bold"
        >
          Cancel
        </v-btn>
        <v-btn
          color="red-darken-1"
          variant="elevated"
          @click="runExploit"
          :loading="isLoading"
          prepend-icon="mdi-flash"
          class="text-none font-weight-bold ml-2 px-6"
          elevation="2"
        >
          Execute Exploit
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<style scoped>
.exploit-dialog-card {
    overflow: hidden;
}
.dialog-header {
    background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
}
.input-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #475569;
    display: block;
}
.modern-input :deep(.v-field__outline__start){
    border-radius: 8px 0 0 8px !important;
}
.modern-input :deep(.v-field__outline__end){
     border-radius: 0 8px 8px 0 !important;
}
.credentials-box {
    background: rgba(99, 102, 241, 0.05);
    border: 1px dashed rgba(99, 102, 241, 0.3);
}
.terminal-window {
    border: 1px solid #333;
}
.terminal-body {
    font-family: 'Courier New', Courier, monospace;
    max-height: 200px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #555 #111;
}
.terminal-body::-webkit-scrollbar { width: 4px; }
.terminal-body::-webkit-scrollbar-track { background: #111; }
.terminal-body::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
.log-entry { line-height: 1.4; word-break: break-word; }
.blinking-cursor {
    display: inline-block;
    width: 6px;
    height: 12px;
    background-color: white;
    animation: blink 1s step-end infinite;
}
@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
}
.code-output {
    font-family: 'Fira Code', monospace;
    font-size: 0.85rem;
    white-space: pre-wrap;
    word-break: break-all;
}
</style>
