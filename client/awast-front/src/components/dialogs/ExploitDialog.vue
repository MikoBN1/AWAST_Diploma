<script setup lang="ts">
import { ref, watch } from 'vue';

const props = defineProps<{
  modelValue: boolean;
  initialUrl: string;
  initialMethod: string;
  initialVulnType: string;
}>();

const emit = defineEmits(['update:modelValue']);

// Form State
const targetUrl = ref(props.initialUrl);
const method = ref(props.initialMethod);
const vulnType = ref(props.initialVulnType);
const params = ref('');
const username = ref('');
const password = ref('');
const loginUrl = ref('');
const showCredentials = ref(false);
const showPassword = ref(false);

// Execution State
const isLoading = ref(false);
const exploitResult = ref<string | null>(null);

// Watch for prop changes to reset/update form when opening
watch(() => props.modelValue, (newVal) => {
    if (newVal) {
        targetUrl.value = props.initialUrl;
        method.value = props.initialMethod;
        vulnType.value = props.initialVulnType;
        exploitResult.value = null; // Reset results
    }
});

const closeDialog = () => {
    emit('update:modelValue', false);
};

const runExploit = async () => {
  isLoading.value = true;
  exploitResult.value = null;
  
  // TODO: Implement actual API call to /exploiter/run
  setTimeout(() => {
    isLoading.value = false;
    exploitResult.value = `[+] Exploit Execution Complete for ${targetUrl.value}\n[+] Method: ${method.value}\n[+] Type: ${vulnType.value}\n\n[-] No active exploitation confirmed (Mock Result).`;
  }, 2000);
};
</script>

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="emit('update:modelValue', $event)"
    max-width="800px"
    scrollable
  >
    <v-card class="exploit-dialog-card rounded-xl">
      <v-card-title class="dialog-header py-4 px-6 d-flex align-center justify-space-between">
        <div class="d-flex align-center">
             <v-icon icon="mdi-flash" color="red-accent-2" class="mr-3" size="28"></v-icon>
            <span class="text-h6 font-weight-bold text-white">Run Exploit</span>
        </div>
        <v-btn icon="mdi-close" variant="text" color="white" @click="closeDialog"></v-btn>
      </v-card-title>

      <v-card-text class="pa-6 bg-grey-lighten-5">
        <v-container class="pa-0">
             <!-- Target Info -->
              <v-row>
                  <v-col cols="12" md="8">
                      <label class="input-label mb-2">Target URL</label>
                       <v-text-field
                          v-model="targetUrl"
                          density="compact"
                          variant="outlined"
                          bg-color="white"
                          hide-details="auto"
                          class="mb-4 modern-input"
                          prepend-inner-icon="mdi-link"
                       ></v-text-field>
                  </v-col>
                   <v-col cols="12" md="4">
                       <label class="input-label mb-2">Method</label>
                        <v-select
                          v-model="method"
                          :items="['GET', 'POST', 'PUT', 'DELETE']"
                          density="compact"
                          variant="outlined"
                          bg-color="white"
                          hide-details="auto"
                          class="mb-4 modern-input"
                           prepend-inner-icon="mdi-api"
                        ></v-select>
                  </v-col>
              </v-row>
              
               <v-row>
                   <v-col cols="12">
                       <label class="input-label mb-2">Vulnerability Type</label>
                        <v-text-field
                          v-model="vulnType"
                          density="compact"
                           variant="outlined"
                           bg-color="white"
                           hide-details="auto"
                           class="mb-4 modern-input"
                           prepend-inner-icon="mdi-bug"
                        ></v-text-field>
                   </v-col>
               </v-row>

               <v-row>
                  <v-col cols="12">
                     <label class="input-label mb-2">Parameters (JSON/Query)</label>
                      <v-text-field
                          v-model="params"
                          density="compact"
                           variant="outlined"
                           bg-color="white"
                           hide-details="auto"
                           placeholder="id=1"
                           class="mb-4 modern-input"
                           prepend-inner-icon="mdi-code-braces"
                        ></v-text-field>
                  </v-col>
               </v-row>
               
               <!-- Auth Toggle -->
               <div class="d-flex align-center mb-4">
                    <v-switch
                        v-model="showCredentials"
                        label="Use Authentication"
                        color="primary"
                        hide-details
                        density="compact"
                        inset
                    ></v-switch>
               </div>
               
               <!-- Credentials -->
               <v-expand-transition>
                   <div v-if="showCredentials" class="credentials-box pa-4 mb-4 rounded-lg">
                       <v-row dense>
                           <v-col cols="12">
                                <v-text-field
                                  v-model="loginUrl"
                                  label="Login URL"
                                  density="compact"
                                  variant="outlined"
                                  bg-color="white"
                                  hide-details="auto"
                                  class="mb-2"
                                ></v-text-field>
                           </v-col>
                           <v-col cols="6">
                                <v-text-field
                                  v-model="username"
                                  label="Username"
                                  density="compact"
                                  variant="outlined"
                                  bg-color="white"
                                  hide-details="auto"
                                ></v-text-field>
                           </v-col>
                           <v-col cols="6">
                                <v-text-field
                                  v-model="password"
                                  label="Password"
                                  :type="showPassword ? 'text' : 'password'"
                                  :append-inner-icon="showPassword ? 'mdi-eye-off' : 'mdi-eye'"
                                  @click:append-inner="showPassword = !showPassword"
                                  density="compact"
                                  variant="outlined"
                                  bg-color="white"
                                  hide-details="auto"
                                ></v-text-field>
                           </v-col>
                       </v-row>
                   </div>
               </v-expand-transition>
               
               <!-- Results -->
               <v-expand-transition>
                   <div v-if="exploitResult" class="results-container mt-4">
                       <h4 class="text-subtitle-2 font-weight-bold mb-2 text-grey-darken-3">Execution Result</h4>
                       <v-card variant="flat" color="#1e1e1e" class="pa-4 rounded-lg">
                           <pre class="code-output text-green-accent-3">{{ exploitResult }}</pre>
                       </v-card>
                   </div>
               </v-expand-transition>

        </v-container>
      </v-card-text>

      <v-divider></v-divider>

      <v-card-actions class="pa-4 bg-white">
        <v-spacer></v-spacer>
        <v-btn
          variant="text"
          color="grey-darken-1"
          @click="closeDialog"
          class="text-none font-weight-bold"
        >
          Cancel
        </v-btn>
        <v-btn
          color="red-darken-1"
          variant="elevated"
          @click="runExploit"
          :loading="isLoading"
          prepend-icon="mdi-flash"
          class="text-none font-weight-bold ml-2 px-6"
          elevation="2"
        >
          Execute Exploit
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<style scoped>
.exploit-dialog-card {
    overflow: hidden;
}
.dialog-header {
    background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
}
.input-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #475569;
    display: block;
}
.modern-input :deep(.v-field__outline__start){
    border-radius: 8px 0 0 8px !important;
}
.modern-input :deep(.v-field__outline__end){
     border-radius: 0 8px 8px 0 !important;
}
.credentials-box {
    background: rgba(99, 102, 241, 0.05);
    border: 1px dashed rgba(99, 102, 241, 0.3);
}
.code-output {
    font-family: 'Fira Code', monospace;
    font-size: 0.85rem;
    white-space: pre-wrap;
    word-break: break-all;
}
</style>
