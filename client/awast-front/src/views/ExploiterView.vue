<script setup lang="ts">
import { ref, computed, watch } from "vue";
import exploiterService from '@/services/exploiterService';
import swaggerDataOrig from '@/assets/swagger/swagger.json';
import type { ExploiterResponse } from '@/types/api';

const targetUrl = ref('');
const params = ref('');
const vulnType = ref('');
const method = ref('');

// Cookies key-value editor
interface CookieEntry {
  key: string;
  value: string;
}
const cookieEntries = ref<CookieEntry[]>([]);
const showCookies = ref(false);

const addCookieEntry = () => {
  cookieEntries.value.push({ key: '', value: '' });
};

const removeCookieEntry = (index: number) => {
  cookieEntries.value.splice(index, 1);
};

const buildCookiesObject = (): Record<string, string> | undefined => {
  const entries = cookieEntries.value.filter(e => e.key.trim() !== '');
  if (entries.length === 0) return undefined;
  return Object.fromEntries(entries.map(e => [e.key.trim(), e.value]));
};

const swaggerData: any = swaggerDataOrig;

const swaggerEndpoints = computed(() => {
  const endpoints = [];
  if (swaggerData && swaggerData.paths) {
    for (const [path, methods] of Object.entries(swaggerData.paths)) {
      for (const [methodName] of Object.entries(methods as Record<string, any>)) {
        endpoints.push({
          title: `${methodName.toUpperCase()} ${path}`,
          path: path,
          method: methodName.toUpperCase(),
        });
      }
    }
  }
  return endpoints;
});

const selectedEndpoint = ref<any>(null);

watch(selectedEndpoint, (newVal) => {
  if (newVal) {
    targetUrl.value = newVal.path;
    method.value = newVal.method;
  }
});

const isLoading = ref(false);
const exploitResult = ref<ExploiterResponse | null>(null);
const errorMsg = ref('');

// WebSocket Logs
interface WsLog {
  type: string;
  message?: string;
  payload?: string;
  timestamp: Date;
}
const wsLogs = ref<WsLog[]>([]);
let activeSocket: WebSocket | null = null;
const terminalContainer = ref<HTMLElement | null>(null);

const scrollToBottom = () => {
    setTimeout(() => {
        if (terminalContainer.value) {
            terminalContainer.value.scrollTop = terminalContainer.value.scrollHeight;
        }
    }, 50);
};

const runExploit = async () => {
  if (!targetUrl.value) {
    errorMsg.value = 'Please enter a target URL';
    return;
  }
  errorMsg.value = '';
  isLoading.value = true;
  exploitResult.value = null;
  wsLogs.value = [];

  // 1. Generate WS ID
  const wsId = crypto.randomUUID();
  
  // 2. Connect WebSocket
  if (activeSocket) {
      activeSocket.close();
  }
  
  const baseUrl = import.meta.env.VITE_API_URL || 'http://localhost:8000/api/v1';
  const wsUrl = baseUrl.replace(/^http/, 'ws') + `/exploiter/ws/${wsId}`;
  activeSocket = new WebSocket(wsUrl);
  
  activeSocket.onmessage = (event) => {
      try {
          const data = JSON.parse(event.data);
          wsLogs.value.push({
              ...data,
              timestamp: new Date()
          });
          scrollToBottom();
      } catch (e) {
          console.error("Failed to parse WS message", e);
      }
  };
  
  activeSocket.onerror = (error) => {
      console.error("WebSocket Error:", error);
      wsLogs.value.push({ type: 'failed', message: 'WebSocket connection error', timestamp: new Date() });
  };

  try {
    const data = {
      target: targetUrl.value,
      params: params.value,
      vuln_type: vulnType.value,
      cookies: buildCookiesObject(),
      method: method.value,
      ws_id: wsId,
    };
    const response = await exploiterService.runExploit(data);
    exploitResult.value = response as ExploiterResponse;
  } catch (error: any) {
    errorMsg.value = error?.response?.data?.detail || 'Exploit execution failed';
  } finally {
    isLoading.value = false;
    if (activeSocket && activeSocket.readyState === WebSocket.OPEN) {
        setTimeout(() => {
             if (activeSocket) activeSocket.close();
        }, 2000);
    }
  }
};
</script>

<template>
  <div class="exploiter-container">
    <div class="hero-section">
      <div class="hero-content">
        <div class="icon-badge mb-4">
          <v-icon icon="mdi-bomb" size="48" color="red-accent-2"></v-icon>
        </div>
        <h1 class="text-h3 font-weight-bold text-slate-800 mb-3">Vulnerability Exploiter</h1>
        <p class="text-subtitle-1 text-white mb-0">
          AI-powered exploitation engine to verify and confirm vulnerabilities
        </p>
      </div>
    </div>

    <v-container class="px-4">
      <v-row justify="center" class="mb-8">
        <v-col cols="12" md="8" lg="6">
          <v-card class="glass-card" elevation="0">
            <v-card-text class="pa-8">
              <div class="card-header mb-6">
                <div class="icon-wrapper gradient-alert mb-4">
                  <v-icon icon="mdi-target" size="32" color="white"></v-icon>
                </div>
                <h2 class="text-h5 font-weight-bold text-slate-800 mb-2">Configure Exploit</h2>
                <p class="text-body-2 text-grey-darken-1">
                  Define target parameters and payload settings
                </p>
              </div>

              <!-- Error Alert -->
              <v-alert v-if="errorMsg" type="error" variant="tonal" density="compact" class="mb-4" closable @click:close="errorMsg = ''">{{ errorMsg }}</v-alert>

              <!-- Swagger Endpoint Selector -->
              <div class="mb-5">
                <label class="input-label mb-2">Load from API (Swagger)</label>
                <v-autocomplete
                  v-model="selectedEndpoint"
                  :items="swaggerEndpoints"
                  item-title="title"
                  return-object
                  density="comfortable"
                  placeholder="Search and select an API endpoint to exploit"
                  prepend-inner-icon="mdi-api"
                  variant="outlined"
                  class="modern-input"
                  hide-details
                  clearable
                ></v-autocomplete>
              </div>

              <!-- Target URL -->
              <div class="mb-5">
                <label class="input-label mb-2">Target URL</label>
                <v-text-field
                  v-model="targetUrl"
                  density="comfortable"
                  placeholder="http://example.com/api/user/1"
                  prepend-inner-icon="mdi-link-variant"
                  variant="outlined"
                  class="modern-input"
                  hide-details
                ></v-text-field>
              </div>

              <!-- Params -->
              <div class="mb-5">
                <label class="input-label mb-2">Vulnerable Parameter</label>
                <v-text-field
                  v-model="params"
                  density="comfortable"
                  placeholder="e.g., id"
                  prepend-inner-icon="mdi-code-braces"
                  variant="outlined"
                  class="modern-input"
                  hide-details
                ></v-text-field>
              </div>

              <!-- Method -->
              <div class="mb-5">
                <label class="input-label mb-2">HTTP Method</label>
                <v-select
                  v-model="method"
                  :items="['GET', 'POST', 'PUT', 'DELETE']"
                  density="comfortable"
                  placeholder="Select Method"
                  prepend-inner-icon="mdi-api"
                  variant="outlined"
                  class="modern-input"
                  hide-details
                ></v-select>
              </div>

              <!-- Vuln Type -->
              <div class="mb-5">
                <label class="input-label mb-2">Vulnerability Type</label>
                <v-text-field
                  v-model="vulnType"
                  density="comfortable"
                  placeholder="e.g., SQL Injection, XSS"
                  prepend-inner-icon="mdi-bug"
                  variant="outlined"
                  class="modern-input"
                  hide-details
                ></v-text-field>
              </div>

              <!-- Cookies Toggle -->
              <div class="auth-section mb-5">
                <v-card class="toggle-card pa-4" elevation="0">
                  <div class="d-flex align-center justify-space-between">
                    <div class="d-flex align-center">
                      <v-icon icon="mdi-cookie" color="primary" class="mr-3"></v-icon>
                      <div>
                        <div class="font-weight-medium text-slate-800">Session Cookies</div>
                        <div class="text-caption text-grey-darken-1">Provide session cookies for authenticated routes</div>
                      </div>
                    </div>
                    <v-switch
                      v-model="showCookies"
                      hide-details
                      color="primary"
                      inset
                      class="ml-4"
                    ></v-switch>
                  </div>
                </v-card>
              </div>

              <!-- Cookies Editor -->
              <div v-if="showCookies" class="credentials-section">
                <div v-for="(entry, index) in cookieEntries" :key="index" class="d-flex align-center mb-3 cookie-row">
                  <v-text-field
                    v-model="entry.key"
                    density="compact"
                    placeholder="Cookie name (e.g. PHPSESSID)"
                    variant="outlined"
                    class="modern-input mr-2"
                    hide-details
                  ></v-text-field>
                  <v-text-field
                    v-model="entry.value"
                    density="compact"
                    placeholder="Cookie value"
                    variant="outlined"
                    class="modern-input mr-2"
                    hide-details
                  ></v-text-field>
                  <v-btn
                    icon="mdi-close"
                    size="small"
                    variant="text"
                    color="red"
                    @click="removeCookieEntry(index)"
                  ></v-btn>
                </div>
                <v-btn
                  variant="tonal"
                  color="primary"
                  size="small"
                  prepend-icon="mdi-plus"
                  class="text-none"
                  @click="addCookieEntry"
                >
                  Add Cookie
                </v-btn>
              </div>

              <!-- Run Button -->
              <v-btn
                block
                size="x-large"
                color="red-darken-1"
                variant="elevated"
                class="text-none font-weight-bold glow-button mt-6"
                prepend-icon="mdi-flash"
                @click="runExploit"
                :loading="isLoading"
              >
                Run Exploit
              </v-btn>

              <!-- Real-time Terminal Area -->
              <div v-if="isLoading || wsLogs.length > 0" class="terminal-area mt-8">
                <div class="d-flex align-center justify-space-between mb-2">
                    <h3 class="text-h6 font-weight-bold">Exploitation Logs</h3>
                    <v-chip v-if="isLoading" color="primary" size="small" variant="flat">
                        <v-progress-circular indeterminate size="12" width="2" class="mr-2"></v-progress-circular>
                        Running
                    </v-chip>
                </div>
                <v-card class="bg-black pa-4 terminal-window" elevation="0" rounded="lg">
                    <div class="terminal-header d-flex align-center mb-4">
                        <span class="dot red"></span>
                        <span class="dot yellow"></span>
                        <span class="dot green"></span>
                    </div>
                    <div class="terminal-body" ref="terminalContainer">
                        <div v-if="wsLogs.length === 0" class="text-grey-darken-1 text-caption font-italic">
                            Initializing exploit runner and connecting to LLM...
                        </div>
                        <div v-for="(log, idx) in wsLogs" :key="idx" class="log-entry mb-2 text-body-2">
                            <span class="timestamp text-grey-darken-1 mr-2">[{{ log.timestamp.toLocaleTimeString() }}]</span>
                            
                            <!-- Format based on type -->
                            <span v-if="log.type === 'info'" class="text-blue-lighten-2">[SYSTEM] {{ log.message }}</span>
                            <span v-else-if="log.type === 'log'" class="text-white">&gt; {{ log.message }}</span>
                            <span v-else-if="log.type === 'attack'" class="text-yellow-accent-2">[ATTACK] Trying payload: <span class="text-white bg-grey-darken-3 px-1 rounded">{{ log.payload }}</span></span>
                            <span v-else-if="log.type === 'success'" class="text-green-accent-3 font-weight-bold">[VULNERABLE] {{ log.message }}</span>
                            <span v-else-if="log.type === 'failed'" class="text-red-accent-2">[FAILED] {{ log.message || 'Payload failed validation.' }}</span>
                            <span v-else class="text-white">{{ log.message }}</span>
                        </div>
                        <div v-if="isLoading" class="log-entry mt-2 text-body-2">
                            <span class="blinking-cursor">_</span>
                        </div>
                    </div>
                </v-card>
              </div>

              <!-- Structured Results Area -->
              <div v-if="exploitResult && !isLoading" class="results-area mt-8">
                <h3 class="text-h6 font-weight-bold mb-3">Final Report</h3>

                <!-- Confirmed -->
                <template v-if="exploitResult.status === 'confirmed'">
                  <v-alert type="success" variant="tonal" class="mb-4" prominent>
                    <div class="font-weight-bold">Vulnerability Confirmed!</div>
                    <div class="text-body-2 mt-1">{{ exploitResult.message }}</div>
                  </v-alert>
                  <v-card variant="outlined" class="pa-5 border-success border-opacity-50 border-sm result-card">
                    <div class="result-grid">
                      <div class="result-item mb-4">
                        <div class="result-label text-grey-darken-1 text-caption font-weight-bold">VULNERABILITY TYPE</div>
                        <div class="text-body-1 font-weight-medium">{{ exploitResult.vuln_type }}</div>
                      </div>
                      <div class="result-item mb-4">
                        <div class="result-label text-grey-darken-1 text-caption font-weight-bold">TARGET</div>
                        <div class="text-body-1 font-weight-medium">{{ exploitResult.target }}</div>
                      </div>
                      <div class="result-item mb-4">
                        <div class="result-label text-grey-darken-1 text-caption font-weight-bold">PARAMETER</div>
                        <v-chip color="red" variant="tonal" size="small">{{ exploitResult.parameter }}</v-chip>
                      </div>
                      <div class="result-item mb-4">
                        <div class="result-label text-grey-darken-1 text-caption font-weight-bold">WORKING PAYLOAD</div>
                        <code class="payload-code pa-2 rounded">{{ exploitResult.working_payload }}</code>
                      </div>
                      <div class="result-item mb-4">
                        <div class="result-label text-grey-darken-1 text-caption font-weight-bold">PROOF</div>
                        <div class="text-body-2">{{ exploitResult.proof }}</div>
                      </div>
                      <div class="result-item mb-4">
                        <div class="result-label text-grey-darken-1 text-caption font-weight-bold">CURL REPRODUCTION</div>
                        <code class="payload-code pa-2 rounded d-block">{{ exploitResult.curl }}</code>
                      </div>
                      <div class="result-item">
                        <div class="result-label text-grey-darken-1 text-caption font-weight-bold">ALL TRIED PAYLOADS ({{ exploitResult.tried_payloads.length }})</div>
                        <div class="tried-payloads mt-2">
                          <v-chip
                            v-for="(p, i) in exploitResult.tried_payloads"
                            :key="i"
                            size="small"
                            variant="outlined"
                            class="mr-1 mb-1"
                          >{{ p }}</v-chip>
                        </div>
                      </div>
                    </div>
                  </v-card>
                </template>

                <!-- Potential -->
                <template v-else-if="exploitResult.status === 'potential'">
                  <v-alert type="warning" variant="tonal" class="mb-4" prominent>
                    <div class="font-weight-bold">Potential Vulnerability</div>
                    <div class="text-body-2 mt-1">{{ exploitResult.message }}</div>
                  </v-alert>
                  <v-card variant="outlined" class="pa-5 result-card">
                    <div class="result-label text-grey-darken-1 text-caption font-weight-bold mb-2">TRIED PAYLOADS ({{ exploitResult.tried_payloads.length }})</div>
                    <div class="tried-payloads">
                      <v-chip
                        v-for="(p, i) in exploitResult.tried_payloads"
                        :key="i"
                        size="small"
                        variant="outlined"
                        class="mr-1 mb-1"
                      >{{ p }}</v-chip>
                    </div>
                  </v-card>
                </template>
              </div>

            </v-card-text>
          </v-card>
        </v-col>
      </v-row>
    </v-container>
  </div>
</template>

<style scoped>
.exploiter-container {
  min-height: 100vh;
  padding-bottom: 48px;
}

.hero-section {
  background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
  padding: 80px 24px 100px;
  position: relative;
  overflow: hidden;
}

.hero-section::before {
   content: '';
   position: absolute;
   top: 0;left: 0;right: 0;bottom: 0;
   background: rgba(255,255,255,0.05);
}

.hero-content {
  text-align: center;
  position: relative;
  z-index: 1;
  max-width: 800px;
  margin: 0 auto;
}

.icon-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 96px;
    height: 96px;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 24px;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.hero-section h1, .hero-section p {
    color: white;
}

.glass-card {
  background: rgba(255, 255, 255, 0.98) !important;
  border-radius: 24px;
  border: 1px solid rgba(0,0,0,0.05);
  margin-top: -60px;
  position: relative;
  z-index: 2;
}

.card-header { text-align: center; }

.icon-wrapper {
  display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 80px;
    border-radius: 20px;
    box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
}

.gradient-alert {
    background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
}

.input-label {
    font-weight: 600;
    font-size: 0.875rem;
    color: #334155;
}

.modern-input :deep(.v-field) {
    border-radius: 12px;
}

.toggle-card {
    background: #f8fafc !important;
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: 16px;
}

.credentials-section {
    padding: 16px;
    background: rgba(239, 68, 68, 0.03);
    border-radius: 16px;
    border: 1px dashed rgba(239, 68, 68, 0.2);
    margin-bottom: 24px;
}

.cookie-row {
    gap: 8px;
}

.glow-button {
    box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    border-radius: 12px;
}

.terminal-window {
    border: 1px solid #333;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
}

.terminal-header .dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}
.terminal-header .dot.red { background-color: #ff5f56; }
.terminal-header .dot.yellow { background-color: #ffbd2e; }
.terminal-header .dot.green { background-color: #27c93f; }

.terminal-body {
    font-family: 'Courier New', Courier, monospace;
    height: 300px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #555 #111;
}

.terminal-body::-webkit-scrollbar {
    width: 6px;
}
.terminal-body::-webkit-scrollbar-track {
    background: #111;
}
.terminal-body::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 3px;
}

.log-entry {
    line-height: 1.4;
    word-break: break-word;
}

.blinking-cursor {
    display: inline-block;
    width: 8px;
    height: 15px;
    background-color: white;
    animation: blink 1s step-end infinite;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
}

.border-success {
    border-color: #4caf50 !important;
}

.result-card {
    border-radius: 16px;
}

.payload-code {
    display: inline-block;
    background: #1e1e1e;
    color: #e06c75;
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.875rem;
    word-break: break-all;
}
</style>
